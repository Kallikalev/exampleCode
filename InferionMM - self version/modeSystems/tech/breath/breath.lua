require "/scripts/vec2.lua"

local breathImages = {
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;0e010400=e1e1e180;0f010300=e1e1e180;0f010400=fdfdfd80;0f010500=e1e1e180;10010300=e1e1e180;10010400=fdfdfd80;10010500=e1e1e180;11010200=e1e1e180;11010300=fdfdfd80;11010400=fdfdfd80;11010500=e1e1e180;12010200=e1e1e180;12010300=fdfdfd80;12010400=e1e1e180;13010200=e1e1e180;13010300=fdfdfd80;13010400=e1e1e180;14010300=e1e1e180;14010400=e1e1e180;15010300=e1e1e180;15010400=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;02010300=e1e1e180;02010400=e1e1e180;03010200=e1e1e180;03010300=fdfdfd80;03010400=fdfdfd80;03010500=e1e1e180;04010200=e1e1e180;04010300=fdfdfd80;04010400=fdfdfd80;04010500=e1e1e180;05010200=e1e1e180;05010300=fdfdfd80;05010400=fdfdfd80;05010500=fdfdfd80;05010600=e1e1e180;06010100=e1e1e180;06010200=fdfdfd80;06010300=fdfdfd80;06010400=fdfdfd80;06010500=fdfdfd80;06010600=e1e1e180;07010100=e1e1e180;07010200=fdfdfd80;07010300=fdfdfd80;07010400=e1e1e180;07010500=fdfdfd80;07010600=fdfdfd80;07010700=e1e1e180;08010100=e1e1e180;08010200=e1e1e180;08010300=e1e1e180;08010400=fdfdfd80;08010500=fdfdfd80;08010600=fdfdfd80;08010700=e1e1e180;09010100=e1e1e180;09010200=fdfdfd80;09010300=e1e1e180;09010400=fdfdfd80;09010500=fdfdfd80;09010600=fdfdfd80;09010700=e1e1e180;0a010100=e1e1e180;0a010200=fdfdfd80;0a010300=e1e1e180;0a010400=fdfdfd80;0a010500=fdfdfd80;0a010600=fdfdfd80;0a010700=e1e1e180;0b010000=e1e1e180;0b010100=fdfdfd80;0b010200=fdfdfd80;0b010300=e1e1e180;0b010400=fdfdfd80;0b010500=fdfdfd80;0b010600=e1e1e180;0c010000=e1e1e180;0c010100=fdfdfd80;0c010200=e1e1e180;0c010300=e1e1e180;0c010400=fdfdfd80;0c010500=fdfdfd80;0c010600=e1e1e180;0d010000=e1e1e180;0d010100=fdfdfd80;0d010200=e1e1e180;0d010300=e1e1e180;0d010400=e1e1e180;0d010500=e1e1e180;0e010100=e1e1e180;0e010200=e1e1e180;0e010300=e1e1e180;0e010400=fdfdfd80;0e010500=fdfdfd80;0e010600=e1e1e180;0f010200=e1e1e180;0f010300=fdfdfd80;0f010400=fdfdfd80;0f010500=fdfdfd80;0f010600=e1e1e180;10010200=e1e1e180;10010300=fdfdfd80;10010400=fdfdfd80;10010500=fdfdfd80;10010600=e1e1e180;11010200=e1e1e180;11010300=fdfdfd80;11010400=fdfdfd80;11010500=e1e1e180;12010300=e1e1e180;12010400=fdfdfd80;12010500=e1e1e180;13010300=e1e1e180;13010400=e1e1e180;14010300=e1e1e180;14010400=e1e1e180;15010400=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;01010300=e1e1e180;01010400=e1e1e180;02010200=e1e1e180;02010300=fdfdfd80;02010400=fdfdfd80;02010500=e1e1e180;03010200=e1e1e180;03010300=fdfdfd80;03010400=fdfdfd80;03010500=e1e1e180;04010300=e1e1e180;04010400=fdfdfd80;04010500=fdfdfd80;04010600=e1e1e180;05010300=e1e1e180;05010400=e1e1e180;05010500=e1e1e180;05010600=e1e1e180;05010700=e1e1e180;06010200=e1e1e180;06010300=fdfdfd80;06010400=fdfdfd80;06010500=e1e1e180;06010600=fdfdfd80;06010700=fdfdfd80;06010800=e1e1e180;07010200=e1e1e180;07010300=fdfdfd80;07010400=fdfdfd80;07010500=e1e1e180;07010600=fdfdfd80;07010700=fdfdfd80;07010800=e1e1e180;08010200=e1e1e180;08010300=fdfdfd80;08010400=e1e1e180;08010500=fdfdfd80;08010600=fdfdfd80;08010700=fdfdfd80;08010800=e1e1e180;09010300=e1e1e180;09010400=e1e1e180;09010500=fdfdfd80;09010600=fdfdfd80;09010700=fdfdfd80;09010800=e1e1e180;0a010200=e1e1e180;0a010300=e1e1e180;0a010400=e1e1e180;0a010500=e1e1e180;0a010600=fdfdfd80;0a010700=e1e1e180;0b010200=e1e1e180;0b010300=e1e1e180;0b010400=e1e1e180;0b010500=e1e1e180;0b010600=e1e1e180;0c010100=e1e1e180;0c010200=fdfdfd80;0c010300=e1e1e180;0c010400=e1e1e180;0c010500=e1e1e180;0c010600=e1e1e180;0d010100=e1e1e180;0d010200=fdfdfd80;0d010300=fdfdfd80;0d010400=e1e1e180;0d010500=fdfdfd80;0d010600=fdfdfd80;0d010700=e1e1e180;0e010200=e1e1e180;0e010300=fdfdfd80;0e010400=e1e1e180;0e010500=fdfdfd80;0e010600=fdfdfd80;0e010700=e1e1e180;0f010300=e1e1e180;0f010400=e1e1e180;0f010500=fdfdfd80;0f010600=e1e1e180;10010400=e1e1e180;10010500=e1e1e180;11010400=e1e1e180;11010500=e1e1e180;12010400=e1e1e180;13010400=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;01010400=e1e1e180;01010500=e1e1e180;02010300=e1e1e180;02010400=fdfdfd80;02010500=fdfdfd80;02010600=e1e1e180;03010300=e1e1e180;03010400=fdfdfd80;03010500=fdfdfd80;03010600=e1e1e180;04010400=e1e1e180;04010500=e1e1e180;04010600=e1e1e180;05010500=e1e1e180;05010600=e1e1e180;05010700=e1e1e180;05010800=e1e1e180;06010300=e1e1e180;06010400=e1e1e180;06010500=fdfdfd80;06010600=fdfdfd80;06010700=fdfdfd80;06010800=fdfdfd80;06010900=e1e1e180;07010300=e1e1e180;07010400=fdfdfd80;07010500=fdfdfd80;07010600=fdfdfd80;07010700=fdfdfd80;07010800=fdfdfd80;07010900=e1e1e180;08010400=e1e1e180;08010500=e1e1e180;08010600=fdfdfd80;08010700=fdfdfd80;08010800=e1e1e180;09010400=e1e1e180;09010500=e1e1e180;09010600=e1e1e180;09010700=e1e1e180;0a010200=e1e1e180;0a010300=e1e1e180;0a010400=fdfdfd80;0a010500=fdfdfd80;0a010600=e1e1e180;0b010200=e1e1e180;0b010300=fdfdfd80;0b010400=fdfdfd80;0b010500=fdfdfd80;0b010600=fdfdfd80;0b010700=e1e1e180;0c010300=e1e1e180;0c010400=fdfdfd80;0c010500=e1e1e180;0c010600=fdfdfd80;0c010700=fdfdfd80;0c010800=e1e1e180;0d010300=e1e1e180;0d010400=fdfdfd80;0d010500=e1e1e180;0d010600=fdfdfd80;0d010700=fdfdfd80;0d010800=e1e1e180;0e010400=e1e1e180;0e010500=e1e1e180;0e010600=e1e1e180;0e010700=e1e1e180;0f010400=e1e1e180;0f010500=e1e1e180;10010400=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;01010600=e1e1e180;01010700=e1e1e180;02010500=e1e1e180;02010600=e1e1e180;02010700=fdfdfd80;02010800=e1e1e180;03010500=e1e1e180;03010600=e1e1e180;03010700=e1e1e180;05010600=e1e1e180;05010700=e1e1e180;05010800=e1e1e180;05010900=e1e1e180;06010400=e1e1e180;06010500=e1e1e180;06010600=e1e1e180;06010700=e1e1e180;06010800=fdfdfd80;06010900=fdfdfd80;06010a00=e1e1e180;07010400=e1e1e180;07010500=e1e1e180;07010600=e1e1e180;07010700=fdfdfd80;07010800=fdfdfd80;07010900=fdfdfd80;07010a00=e1e1e180;08010500=e1e1e180;08010600=e1e1e180;08010700=e1e1e180;08010800=e1e1e180;08010900=e1e1e180;09010400=e1e1e180;09010500=fdfdfd80;09010600=e1e1e180;09010700=e1e1e180;0a010300=e1e1e180;0a010400=fdfdfd80;0a010500=fdfdfd80;0a010600=e1e1e180;0b010300=e1e1e180;0b010400=fdfdfd80;0b010500=e1e1e180;0b010600=e1e1e180;0b010700=e1e1e180;0b010800=e1e1e180;0c010400=e1e1e180;0c010500=e1e1e180;0c010600=fdfdfd80;0c010700=fdfdfd80;0c010800=fdfdfd80;0c010900=e1e1e180;0d010500=e1e1e180;0d010600=e1e1e180;0d010700=fdfdfd80;0d010800=fdfdfd80;0d010900=e1e1e180;0e010500=e1e1e180;0e010700=e1e1e180;0e010800=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;01010700=e1e1e180;02010700=e1e1e180;02010800=e1e1e180;03010700=e1e1e180;03010800=e1e1e180;05010a00=e1e1e180;06010600=e1e1e180;06010700=e1e1e180;06010800=e1e1e180;06010b00=e1e1e180;07010500=e1e1e180;07010600=e1e1e180;07010800=e1e1e180;07010900=e1e1e180;07010a00=e1e1e180;08010500=e1e1e180;08010800=e1e1e180;0b010600=e1e1e180;0b010700=e1e1e180;0c010400=e1e1e180;0c010500=e1e1e180;0c010700=e1e1e180;0c010800=e1e1e180;0c010900=e1e1e180;0d010a00=e1e1e180;0e010800=e1e1e180;0e010900=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;02010900=e1e1e180;03010800=e1e1e180;03010900=e1e1e180;06010700=e1e1e180;06010800=e1e1e180;07010b00=e1e1e180;0c010600=e1e1e180;0c010700=e1e1e180;0c010a00=e1e1e180;0d010900=e1e1e180;0d010a00=fdfdfd80;0d010b00=e1e1e180;0e010a00=e1e1e180",
	"?setcolor=fff?replace;fff0=fff?crop;0;0;2;2?blendmult=/items/active/weapons/protectorate/aegisaltpistol/beamend.png;0;0?replace;a355c0a5=00010000;a355c07b=2b010000;ffffffa5=00010b00;ffffff7b=2b010b00?scale=44;12?crop;1;1;45;13?replace;02010a00=e1e1e180;06010900=e1e1e180;0e010b00=e1e1e180"
}
local animationRate = 5
local animationFrameTimer = 0
local animationFrameNumber = 1
local animationStartRate = 3 * 60
local animationStartTimer = animationStartRate
local animationRunning = true
local animationDirection = 1
local breathOn = false

function breathInit()
	Bind.create("specialThree right",toggleBreath,false)

	animator.setAnimationState("ballState", "on")
end

function breathUpdate(args)
	if animationRunning then
		if animationFrameTimer == 0 then
			animationFrameTimer = animationRate
			animationFrameNumber = animationFrameNumber + 1
			if animationFrameNumber > #breathImages then
				animationFrameNumber = 1
				animationRunning = false
				animationStartTimer = animationStartRate
			end
		else
			animationFrameTimer = animationFrameTimer - 1
		end
	else
		if breathOn then
			animationStartTimer = animationStartTimer - 1
		end
		if animationStartTimer == 0 then
			animationRunning = true
			animationDirection = mcontroller.facingDirection()
		end
	end

	local ballDirectives = ""
	local ballOffset = {0,0}
	local ballScale = 0.5
	if animationRunning then
		ballDirectives = breathImages[animationFrameNumber]
		if animationDirection == 1 then
			ballOffset = {0.8,0.4}
			ballDirectives = ballDirectives .. "?flipx"
		else
			ballOffset = {-0.8,0.4}
		end
	end
	animator.setGlobalTag("ballDirectives",ballDirectives)
	animator.resetTransformationGroup("ball")
	animator.scaleTransformationGroup("ball",ballScale)
	animator.translateTransformationGroup("ball",ballOffset)
end

function breathUninit()
end

function toggleBreath()
	breathOn = not breathOn
end